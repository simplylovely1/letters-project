<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Letters ‚Äî Ephemeral Speech</title>
  <style>
    body {
      background: #fefefe;
      color: #222;
      font-family: "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      overflow: hidden;
      height: 100vh;
      transition: background 0.2s linear;
    }

    .letter {
      position: absolute;
      font-size: 48px;
      font-weight: 300;
      pointer-events: none;
      user-select: none;
      opacity: 1;
      transition: transform 1s ease-out, opacity 1s ease-out, color 1s ease-out;
      z-index: 10;
    }

    h1, p {
      position: fixed;
      top: 16px;
      left: 20px;
      margin: 0;
      z-index: 100;
    }
    p.line1 { top: 56px; color: #777; font-size: 14px; }
    p.line2 { top: 80px; color: #777; font-size: 14px; }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #444;
      border-radius: 50%;
      pointer-events: none;
      user-select: none;
      z-index: 5;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-family: "Helvetica Neue", Arial, sans-serif;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }
    .overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    #loveMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      color: #ff99cc;
      opacity: 0;
      transition: opacity 1.5s ease;
      pointer-events: none;
      z-index: 2000;
    }
  </style>
</head>

<body>
  <h1>Letters: Ephemeral Speech</h1>
  <p class = "line1">Each keystroke is a breath ‚Äî appearing, fading, forgotten.</p>
  <p class = "line2">We need LOVE.</p>
  <div id="overlay" class="overlay">You need to type more carefully (slowly).</div>
  <div id="loveMessage">Love resets everything.</div>

  <script>
    // üîä AudioContext Íπ®Ïö∞Í∏∞
    document.body.addEventListener("click", () => {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        ctx.resume();
        ctx.close();
      } catch (e) {}
    }, { once: true });

    let letters = [];
    let lastTime = Date.now();
    let currentBrightness = 254;
    let locked = false;
    let inputBuffer = "";

    const overlay = document.getElementById("overlay");
    const loveMsg = document.getElementById("loveMessage");

    function showOverlay() { overlay.classList.add("show"); }
    function hideOverlay() { overlay.classList.remove("show"); }

    function updateBackground(speed) {
      const threshold = 200;
      const step = 8;

      if (speed < threshold) currentBrightness = Math.max(0, currentBrightness - step);
      else currentBrightness = Math.min(254, currentBrightness + step);

      document.body.style.background = `rgb(${currentBrightness},${currentBrightness},${currentBrightness})`;

      if (currentBrightness <= 20 && !locked) {
        locked = true;
        showOverlay();
        playTone(100, 0.5, "sine", 300);
        setTimeout(() => {
          hideOverlay();
          locked = false;
          currentBrightness = 150;
          document.body.style.background = `rgb(${currentBrightness},${currentBrightness},${currentBrightness})`;
        }, 3000);
      }
    }

    function playTone(freq, baseDuration = 0.2, type = "sine", speed = 200) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(ctx.destination);

        const minSpeed = 50, maxSpeed = 500;
        const normalized = Math.max(0, Math.min(1, (speed - minSpeed) / (maxSpeed - minSpeed)));
        gain.gain.setValueAtTime(0.05 + (1 - normalized) * 0.3, ctx.currentTime);
        osc.start();
        const fadeDuration = baseDuration + (1 - normalized) * 0.6;
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + fadeDuration);
        osc.stop(ctx.currentTime + fadeDuration);
        setTimeout(() => ctx.close(), (fadeDuration + 0.1) * 1000);
      } catch(e) {}
    }

    function createLetter(key) {
      const el = document.createElement("span");
      el.className = "letter";
      el.textContent = key;
      el.style.left = `${window.innerWidth / 2 + (Math.random() * 200 - 100)}px`;
      el.style.top = `${window.innerHeight / 2 + (Math.random() * 200 - 100)}px`;
      document.body.appendChild(el);
      letters.push(el);
      return el;
    }

    function calcLifetime(speed) {
      const minLifetime = 10000;
      const maxLifetime = 30000;
      const clampedSpeed = Math.max(50, Math.min(1000, speed));
      const factor = 1 - (clampedSpeed - 50) / 950;
      return minLifetime + factor * (maxLifetime - minLifetime);
    }

    function vowelEffect(el, key, speed) {
      const lifetime = calcLifetime(speed);
      const toneMap = { a: 220, e: 330, i: 440, o: 261, u: 196 };
      playTone(toneMap[key.toLowerCase()] || 300, 0.6, "sine", speed);
      scatterLetters(el, key, speed);
    }

    function consonantEffect(el, speed) {
      const lifetime = calcLifetime(speed);
      playTone(400 + Math.random() * 200, 0.15, "square", speed);
      scatterLetters(el, el.textContent, speed);
    }

    function scatterLetters(el, key, speed) {
      const isSlow = speed > 250;
      const numPieces = isSlow ? 8 : 12;
      const radius = isSlow ? 100 : 250;
      const baseX = el.offsetLeft;
      const baseY = el.offsetTop;

      // Ï§ëÏã¨ Í∏ÄÏûê ÏÉâ
      el.style.color = isSlow ? "#666" : "#111";
      el.style.opacity = 0.8;
      el.style.transform = "scale(1.1)";
      
      for (let i = 0; i < numPieces; i++) {
        const piece = document.createElement("span");
        piece.className = "letter";
        piece.textContent = key;
        piece.style.left = baseX + "px";
        piece.style.top = baseY + "px";
        piece.style.fontSize = isSlow ? "24px" : "18px";
        piece.style.opacity = 0.7;
        piece.style.zIndex = 5;
        document.body.appendChild(piece);

        let dx, dy;

        if (isSlow) {
          // üå∏ Î∂ÄÎìúÎü¨Ïö¥ ÏõêÌòï ÌçºÏßê
          const angle = (i / numPieces) * 2 * Math.PI + Math.random() * 0.3;
          const dist = radius * (0.6 + Math.random() * 0.4);
          dx = Math.cos(angle) * dist;
          dy = Math.sin(angle) * dist;
        } else {
          // ‚ö° Îπ†Î•∏ ÏÑ†Ìòï ÌçºÏßê
          const angle = (Math.random() - 0.5) * 0.4; // ÏßÅÏÑ† Í∑ºÏ≤ò (ÏïΩÍ∞ÑÏùò Ïò§Ï∞®)
          const dist = radius * (0.8 + Math.random() * 0.4);
          dx = Math.cos(angle) * dist * (Math.random() < 0.5 ? 1 : -1);
          dy = Math.sin(angle) * 30; // Í±∞Ïùò ÏßÅÏÑ†Ï≤òÎüº
        }

        requestAnimationFrame(() => {
          piece.style.transform = `translate(${dx}px, ${dy}px) scale(${isSlow ? 1.3 : 1.6}) rotate(${Math.random() * 20 - 10}deg)`;
          piece.style.opacity = 0.4;
          piece.style.color = isSlow ? "#888" : "#333";
          piece.style.transition = "transform 2.5s ease-out, opacity 2.5s ease-out";
        });

        setTimeout(() => {
          piece.style.opacity = 0;
          setTimeout(() => piece.remove(), 2000);
        }, 2000 + Math.random() * 1000);
      }

      // Ï§ëÏã¨ Í∏ÄÏûê Ï≤úÏ≤úÌûà ÏÇ¨ÎùºÏßÄÍ∏∞
      setTimeout(() => {
        el.style.transition = "opacity 1.5s ease-out";
        el.style.opacity = 0;
        setTimeout(() => el.remove(), 1500);
      }, 2000);
    }



    function longPause() {
      const curtain = document.createElement("div");
      curtain.style.position = "fixed";
      curtain.style.left = 0;
      curtain.style.top = 0;
      curtain.style.width = "100%";
      curtain.style.height = "100%";
      curtain.style.background = "white";
      curtain.style.opacity = 0;
      curtain.style.transition = "opacity 1.2s ease";
      curtain.style.zIndex = 999;
      document.body.appendChild(curtain);
      playTone(150, 0.2, "sine", 300);
      setTimeout(() => curtain.style.opacity = 1, 50);
      setTimeout(() => curtain.style.opacity = 0, 1200);
      setTimeout(() => curtain.remove(), 2000);
    }

    function enterBreak() {
      playTone(120, 0.3, "triangle", 300);
      document.body.style.transform = "translateY(8px)";
      setTimeout(() => document.body.style.transform = "translateY(0)", 200);
    }

    // üí• Ìè≠Î∞ú Ìö®Í≥º (Backspace + Love)
    function explodeLast() {
      const last = letters.pop();
      if (!last) return;
      playTone(80, 0.15, "sawtooth", 300);

      for (let i = 0; i < 10; i++) {
        const p = document.createElement("div");
        p.className = "particle";
        let x = last.offsetLeft;
        let y = last.offsetTop;
        let angle = Math.random() * 2 * Math.PI;
        let speedX = Math.cos(angle) * (Math.random() * 2 + 1);
        let speedY = Math.sin(angle) * (Math.random() * 2 + 1);

        document.body.appendChild(p);

        function animateParticle() {
          x += speedX;
          y += speedY;
          if (x < 0 || x > window.innerWidth - 4) speedX *= -1;
          if (y < 0 || y > window.innerHeight - 4) speedY *= -1;
          p.style.left = x + "px";
          p.style.top = y + "px";
          requestAnimationFrame(animateParticle);
        }
        animateParticle();
      }
      last.remove();
    }

    // üíñ love Easter egg
    function triggerLove() {
      if (letters.length === 0) return;

      playTone(440, 0.8, "sine", 100);
      playTone(660, 1, "triangle", 150);

      while (letters.length > 0) explodeLast();

      currentBrightness = 254;
      document.body.style.background = "#fff";

      loveMsg.style.opacity = 1;
      setTimeout(() => loveMsg.style.opacity = 0, 2500);

      const flash = document.createElement("div");
      flash.style.position = "fixed";
      flash.style.inset = 0;
      flash.style.background = "rgba(255,182,193,0.8)";
      flash.style.zIndex = 1500;
      flash.style.transition = "opacity 1s ease";
      document.body.appendChild(flash);
      setTimeout(() => flash.style.opacity = 0, 100);
      setTimeout(() => flash.remove(), 1200);
      document.querySelectorAll('.particle').forEach(p => p.remove());
    }

    document.addEventListener("keydown", function(event) {
      if (locked) return;
      const key = event.key;
      const now = Date.now();
      const speed = now - lastTime;
      lastTime = now;

      // üíñ love Easter egg ÏûÖÎ†• Í∞êÏßÄ
      if (key.length === 1 && /[a-zA-Z]/.test(key)) {
        inputBuffer += key.toLowerCase();
        if (inputBuffer.endsWith("love")) {
          triggerLove();
          inputBuffer = "";
          return;
        }
        if (inputBuffer.length > 8) inputBuffer = inputBuffer.slice(-8);
      }


      updateBackground(speed);
      if (key === "Backspace") return explodeLast();
      if (key === " ") return longPause();
      if (key === "Enter") return enterBreak();
      if (key.length > 1) return;

      const el = createLetter(key);
      if ("aeiouAEIOU".includes(key)) vowelEffect(el, key, speed);
      else consonantEffect(el, speed);
    });
  </script>
</body>
</html>
